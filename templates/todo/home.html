{% extends 'base.html' %}

{% block title %}首頁 - 番茄鐘待辦清單{% endblock %}

{% block content %}
<div class="row">
    <!-- 番茄鐘區域 -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-clock"></i> 番茄鐘計時器
                </h5>
            </div>
            <div class="card-body">
                <div class="pomodoro-timer text-center">
                    <h2 id="timer-display">25:00</h2>
                    <div class="progress mb-3">
                        <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="mb-3">
                        <span class="badge bg-info" id="session-type">工作時段</span>
                        <span class="badge bg-secondary" id="session-count">第 1 個番茄鐘</span>
                    </div>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-success btn-pomodoro" id="start-btn">
                            <i class="bi bi-play-fill"></i> 開始
                        </button>
                        <button type="button" class="btn btn-warning btn-pomodoro" id="pause-btn" style="display: none;">
                            <i class="bi bi-pause-fill"></i> 暫停
                        </button>
                        <button type="button" class="btn btn-danger btn-pomodoro" id="stop-btn">
                            <i class="bi bi-stop-fill"></i> 停止
                        </button>
                    </div>
                </div>
                
                <!-- 選擇待辦事項 -->
                <div class="mt-3">
                    <label for="todo-select" class="form-label">選擇待辦事項：</label>
                    <select class="form-select" id="todo-select">
                        <option value="">請選擇待辦事項</option>
                        {% for todo in todos %}
                            {% if not todo.completed %}
                                <option value="{{ todo.id }}">{{ todo.title }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
                
                <!-- 今日完成的時段 -->
                <div class="mt-4">
                    <h6><i class="bi bi-list-check"></i> 今日完成的時段</h6>
                    <div class="session-history" id="today-sessions">
                        <div class="text-muted text-center">尚無完成的時段</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 待辦事項區域 -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-list-check"></i> 待辦事項
                </h5>
                <a href="{% url 'todo_create' %}" class="btn btn-light btn-sm">
                    <i class="bi bi-plus"></i> 新增
                </a>
            </div>
            <div class="card-body">
                <!-- 過期項目 -->
                {% if overdue_todos %}
                    <div class="alert alert-danger">
                        <h6><i class="bi bi-exclamation-triangle"></i> 過期項目</h6>
                        {% for todo in overdue_todos %}
                            <div class="todo-item card mb-2 overdue">
                                <div class="card-body p-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-1">{{ todo.title }}</h6>
                                            <small class="text-muted">結束日期：{{ todo.end_date }}</small>
                                        </div>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-success toggle-btn" data-id="{{ todo.id }}">
                                                <i class="bi bi-check"></i>
                                            </button>
                                            <a href="{% url 'todo_update' todo.id %}" class="btn btn-outline-primary">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <a href="{% url 'todo_delete' todo.id %}" class="btn btn-outline-danger">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
                
                <!-- 今天到期 -->
                {% if today_todos %}
                    <div class="alert alert-warning">
                        <h6><i class="bi bi-calendar-event"></i> 今天到期</h6>
                        {% for todo in today_todos %}
                            <div class="todo-item card mb-2 due-today">
                                <div class="card-body p-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-1">{{ todo.title }}</h6>
                                            <small class="text-muted">結束日期：{{ todo.end_date }}</small>
                                        </div>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-success toggle-btn" data-id="{{ todo.id }}">
                                                <i class="bi bi-check"></i>
                                            </button>
                                            <a href="{% url 'todo_update' todo.id %}" class="btn btn-outline-primary">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <a href="{% url 'todo_delete' todo.id %}" class="btn btn-outline-danger">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
                
                <!-- 所有待辦事項 -->
                <h6><i class="bi bi-list"></i> 所有待辦事項</h6>
                {% for todo in todos %}
                    <div class="todo-item card mb-2 {% if todo.completed %}completed{% endif %}">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">{{ todo.title }}</h6>
                                    <small class="text-muted">
                                        開始：{{ todo.start_date }} | 結束：{{ todo.end_date }}
                                        {% if todo.description %}
                                            <br>{{ todo.description|truncatechars:50 }}
                                        {% endif %}
                                    </small>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-success toggle-btn" data-id="{{ todo.id }}">
                                        <i class="bi bi-check"></i>
                                    </button>
                                    <a href="{% url 'todo_update' todo.id %}" class="btn btn-outline-primary">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <a href="{% url 'todo_delete' todo.id %}" class="btn btn-outline-danger">
                                        <i class="bi bi-trash"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <div class="text-center text-muted">
                        <i class="bi bi-inbox display-4"></i>
                        <p>尚無待辦事項</p>
                        <a href="{% url 'todo_create' %}" class="btn btn-primary">新增第一個待辦事項</a>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let timer = null;
    let timeLeft = 25 * 60; // 25分鐘
    let totalTime = 25 * 60;
    let isRunning = false;
    let currentSession = null;
    let sessionCount = 1;
    let isWorkSession = true;
    
    // 番茄鐘設定
    const settings = {
        workDuration: {{ settings.work_duration }} * 60,
        breakDuration: {{ settings.break_duration }} * 60,
        longBreakDuration: {{ settings.long_break_duration }} * 60,
        sessionsBeforeLongBreak: {{ settings.sessions_before_long_break }}
    };
    
    function updateDisplay() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        $('#timer-display').text(`${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`);
        
        const progress = ((totalTime - timeLeft) / totalTime) * 100;
        $('#progress-bar').css('width', `${progress}%`);
    }
    
    function startTimer() {
        if (!isRunning) {
            isRunning = true;
            $('#start-btn').hide();
            $('#pause-btn').show();
            
            timer = setInterval(function() {
                timeLeft--;
                updateDisplay();
                
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    isRunning = false;
                    completeSession();
                }
            }, 1000);
        }
    }
    
    function pauseTimer() {
        if (isRunning) {
            clearInterval(timer);
            isRunning = false;
            $('#start-btn').show();
            $('#pause-btn').hide();
        }
    }
    
    function stopTimer() {
        clearInterval(timer);
        isRunning = false;
        timeLeft = totalTime;
        updateDisplay();
        $('#start-btn').show();
        $('#pause-btn').hide();
        
        if (currentSession) {
            // 完成當前時段
            completeSession();
        }
    }
    
    function completeSession() {
        if (currentSession) {
            $.ajax({
                url: '{% url "pomodoro_complete" %}',
                method: 'POST',
                data: JSON.stringify({session_id: currentSession}),
                contentType: 'application/json',
                success: function(response) {
                    addSessionToHistory(response.actual_duration, response.session_type);
                    currentSession = null;
                }
            });
        }
        
        // 播放提示音
        playNotification();
        
        // 顯示完成訊息
        const sessionType = isWorkSession ? '工作' : '休息';
        alert(`${sessionType}時段完成！`);
        
        // 準備下一個時段
        if (isWorkSession) {
            // 工作時段完成，開始休息
            isWorkSession = false;
            timeLeft = sessionCount % settings.sessionsBeforeLongBreak === 0 ? 
                      settings.longBreakDuration : settings.breakDuration;
            totalTime = timeLeft;
            $('#session-type').text('休息時段');
        } else {
            // 休息時段完成，開始工作
            isWorkSession = true;
            sessionCount++;
            timeLeft = settings.workDuration;
            totalTime = timeLeft;
            $('#session-type').text('工作時段');
            $('#session-count').text(`第 ${sessionCount} 個番茄鐘`);
        }
        
        updateDisplay();
        $('#start-btn').show();
        $('#pause-btn').hide();
    }
    
    function addSessionToHistory(duration, sessionType) {
        const historyDiv = $('#today-sessions');
        const sessionText = sessionType === 'work' ? '工作' : '休息';
        // duration 是以分鐘為單位的浮點數，轉換為 MM:SS 格式
        const minutes = Math.floor(duration);
        const seconds = Math.round((duration - minutes) * 60);
        const timeText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        if (historyDiv.find('.text-muted').length > 0) {
            historyDiv.empty();
        }
        
        const sessionHtml = `
            <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                <span>${sessionText}時段</span>
                <span class="badge bg-primary">${timeText}</span>
            </div>
        `;
        historyDiv.append(sessionHtml);
    }
    
    function playNotification() {
        // 簡單的提示音（使用瀏覽器的 Audio API）
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
        audio.play().catch(e => console.log('無法播放提示音'));
    }
    
    // 事件處理
    $('#start-btn').click(function() {
        const selectedTodo = $('#todo-select').val();
        if (!selectedTodo) {
            alert('請先選擇一個待辦事項！');
            return;
        }
        
        if (!currentSession) {
            // 開始新的時段
            $.ajax({
                url: '{% url "pomodoro_start" %}',
                method: 'POST',
                data: JSON.stringify({
                    todo_id: selectedTodo,
                    session_type: isWorkSession ? 'work' : 'break'
                }),
                contentType: 'application/json',
                success: function(response) {
                    currentSession = response.session_id;
                    startTimer();
                }
            });
        } else {
            startTimer();
        }
    });
    
    $('#pause-btn').click(pauseTimer);
    $('#stop-btn').click(stopTimer);
    
    // 待辦事項切換完成狀態
    $('.toggle-btn').click(function() {
        const todoId = $(this).data('id');
        const btn = $(this);
        
        $.ajax({
            url: `/todos/${todoId}/toggle/`,
            method: 'POST',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() || '{{ csrf_token }}'
            },
            success: function(response) {
                const todoItem = btn.closest('.todo-item');
                if (response.completed) {
                    todoItem.addClass('completed');
                } else {
                    todoItem.removeClass('completed');
                }
                location.reload(); // 重新載入頁面以更新狀態
            }
        });
    });
    
    // 初始化顯示
    updateDisplay();
});
</script>
{% endblock %}
