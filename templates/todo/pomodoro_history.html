{% extends 'base.html' %}
{% load todo_extras %}

{% block title %}番茄鐘歷史記錄 - 番茄鐘待辦清單{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-clock-history"></i> 番茄鐘歷史記錄</h2>
    <a href="{% url 'home' %}" class="btn btn-primary">
        <i class="bi bi-arrow-left"></i> 返回首頁
    </a>
</div>

<!-- 統計資訊 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h4>{{ sessions.count }}</h4>
                <p class="mb-0">總時段數</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h4>{{ work_sessions_count }}</h4>
                <p class="mb-0">工作時段</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h4>{{ break_sessions_count }}</h4>
                <p class="mb-0">休息時段</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <h4>{{ total_hours }}h {{ total_minutes }}m</h4>
                <p class="mb-0">總工作時間</p>
            </div>
        </div>
    </div>
</div>

<!-- 篩選器 -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <select class="form-select" id="session-type-filter">
                    <option value="">所有時段類型</option>
                    <option value="work">工作時段</option>
                    <option value="break">休息時段</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="todo-filter">
                    <option value="">所有待辦事項</option>
                    {% for todo in todos %}
                        <option value="{{ todo.id }}">{{ todo.title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <input type="date" class="form-control" id="date-filter" placeholder="選擇日期">
            </div>
            <div class="col-md-3">
                <button class="btn btn-outline-secondary" id="clear-filters">
                    <i class="bi bi-x-circle"></i> 清除篩選
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 歷史記錄列表 -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">時段記錄</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>待辦事項</th>
                        <th>時段類型</th>
                        <th>預定時長</th>
                        <th>實際時長</th>
                        <th>開始時間</th>
                        <th>完成時間</th>
                        <th>效率</th>
                    </tr>
                </thead>
                <tbody id="sessions-table">
                    {% for session in sessions %}
                        <tr data-type="{{ session.session_type }}" 
                            data-todo="{{ session.todo.id }}"
                            data-date="{{ session.started_at|date:'Y-m-d' }}">
                            <td>
                                <strong>{{ session.todo.title }}</strong>
                            </td>
                            <td>
                                {% if session.session_type == 'work' %}
                                    <span class="badge bg-success">工作</span>
                                {% else %}
                                    <span class="badge bg-info">休息</span>
                                {% endif %}
                            </td>
                            <td>{{ session.duration }} 分鐘</td>
                            <td>{{ session.actual_duration|format_duration }}</td>
                            <td>{{ session.started_at|date:"Y-m-d H:i" }}</td>
                            <td>{{ session.completed_at|date:"Y-m-d H:i" }}</td>
                            <td>
                                {% if session.session_type == 'work' %}
                                    {% widthratio session.actual_duration session.duration 100 %}%
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="7" class="text-center text-muted">
                                <i class="bi bi-inbox display-4"></i>
                                <p class="mt-2">尚無完成的番茄鐘時段</p>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // 篩選功能
    function filterSessions() {
        const sessionType = $('#session-type-filter').val();
        const todoId = $('#todo-filter').val();
        const date = $('#date-filter').val();
        
        $('#sessions-table tr').each(function() {
            const row = $(this);
            const type = row.data('type');
            const todo = row.data('todo');
            const rowDate = row.data('date');
            
            let showRow = true;
            
            if (sessionType && type !== sessionType) {
                showRow = false;
            }
            
            if (todoId && todo != todoId) {
                showRow = false;
            }
            
            if (date && rowDate !== date) {
                showRow = false;
            }
            
            row.toggle(showRow);
        });
    }
    
    $('#session-type-filter, #todo-filter, #date-filter').on('change', filterSessions);
    
    // 清除篩選
    $('#clear-filters').click(function() {
        $('#session-type-filter, #todo-filter').val('');
        $('#date-filter').val('');
        filterSessions();
    });
});
</script>
{% endblock %}
